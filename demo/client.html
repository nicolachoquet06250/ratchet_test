<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <title>Websockets</title>
</head>
<body>
<span id="pseudo" style="font-weight: bold;"></span>
<input type="text" id="ws_message" placeholder="Saisissez votre message ici" autofocus />
<button id="send_message">Envoyer le message</button>
<span id="nb_messages"></span>
<div id="board"></div>
    <script>
        window.onload = () => {
            let pseudo  = prompt('Saisissez votre nom :');
            let $pseudo = document.querySelector('#pseudo');
            $pseudo.innerHTML = pseudo + '<hr>';
            let $board = document.querySelector('#board');
            let $msg = document.querySelector('#ws_message');
            let $btn    = document.querySelector('#send_message');
            let $nb_messages = document.querySelector('#nb_messages');
            $nb_messages.innerHTML = '0';

            let socket = new WebSocket("ws://localhost:2107/chat");
            socket.onmessage = (e) => {
                let data = JSON.parse(e.data);
                if(data.connected === true) {
                    $board.innerHTML += '<p><b><i>Vous êtes connecté !</i></b></p>';
                }
                else {
                    let me = false;
                    if(data.user === pseudo) {
                        me = true;
                    }
                    $board.innerHTML += '<p><b>' + (me ? 'Vous' : data.user) + '</b> :<br>' + data.msg + '</p><hr>';
                    $nb_messages.innerHTML = data.nb_messages;
                }
                console.log(e.data);
            };

            $msg.onkeyup = e => {
                if(e.keyCode === 13) {
                    $btn.click();
                }
            };

            socket.onopen = () => {
                socket.send(pseudo);
                $btn.onclick = () => {
                    socket.send($msg.value);
                    $msg.value = '';
                };
            }
        }
    </script>
</body>
</html>